#!/usr/bin/env python

from __future__ import print_function

import logging
import sys

import click

from snuba import settings
from snuba.cleanup import run_cleanup, logger
from snuba.clickhouse import Clickhouse


@click.command()
@click.option('--clickhouse-server', multiple=True,
              help='Clickhouse server to cleanup.')
@click.option('--database-name', default='default',
              help='Name of the database to target.')
@click.option('--table-name', default=settings.DEFAULT_LOCAL_TABLE,
              help='Name of the table to target.')
@click.option('--log-level', default=settings.LOG_LEVEL, help='Logging level to use.')
def run(clickhouse_server, database_name, table_name, log_level):
    logging.basicConfig(level=getattr(logging, log_level.upper()), format='%(asctime)s %(message)s')

    if not clickhouse_server:
        logger.error("Must provide at least one Clickhouse server.")
        sys.exit(1)

    for server in clickhouse_server:
        clickhouse = Clickhouse(clickhouse_server.split(':')[0], port=int(clickhouse_server.split(':')[1]))
        num_dropped = len(run_cleanup(clickhouse, database_name, table_name))
        print("Dropped %s partitions on %s." % (num_dropped, server))


if __name__ == '__main__':
    run()
