#!/usr/bin/env python3

from snuba.clusters.cluster import ClickhouseClientSettings, get_cluster
from snuba.clusters.storage_sets import StorageSetKey
from snuba.manual_jobs import Job, JobLogger, JobSpec

statements = {
    "CREATE TABLE IF NOT EXISTS new_eap_items_1_dist (`organization_id` UInt64, `project_id` UInt64, `item_type` UInt8, `timestamp` DateTime CODEC(DoubleDelta, ZSTD(1)), `trace_id` UUID, `item_id` UInt128, `sampling_weight` UInt64 CODEC(ZSTD(1)), `retention_days` UInt16 CODEC(T64, ZSTD(1)), `attributes_bool` Map(String, Bool), `attributes_int` Map(String, Int64), `attributes_string_0` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_0` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_0)), `attributes_string_1` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_1` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_1)), `attributes_string_2` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_2` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_2)), `attributes_string_3` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_3` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_3)), `attributes_string_4` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_4` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_4)), `attributes_string_5` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_5` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_5)), `attributes_string_6` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_6` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_6)), `attributes_string_7` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_7` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_7)), `attributes_string_8` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_8` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_8)), `attributes_string_9` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_9` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_9)), `attributes_string_10` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_10` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_10)), `attributes_string_11` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_11` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_11)), `attributes_string_12` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_12` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_12)), `attributes_string_13` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_13` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_13)), `attributes_string_14` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_14` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_14)), `attributes_string_15` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_15` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_15)), `attributes_string_16` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_16` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_16)), `attributes_string_17` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_17` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_17)), `attributes_string_18` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_18` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_18)), `attributes_string_19` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_19` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_19)), `attributes_string_20` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_20` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_20)), `attributes_string_21` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_21` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_21)), `attributes_string_22` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_22` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_22)), `attributes_string_23` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_23` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_23)), `attributes_string_24` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_24` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_24)), `attributes_string_25` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_25` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_25)), `attributes_string_26` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_26` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_26)), `attributes_string_27` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_27` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_27)), `attributes_string_28` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_28` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_28)), `attributes_string_29` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_29` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_29)), `attributes_string_30` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_30` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_30)), `attributes_string_31` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_31` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_31)), `attributes_string_32` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_32` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_32)), `attributes_string_33` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_33` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_33)), `attributes_string_34` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_34` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_34)), `attributes_string_35` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_35` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_35)), `attributes_string_36` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_36` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_36)), `attributes_string_37` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_37` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_37)), `attributes_string_38` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_38` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_38)), `attributes_string_39` Map(String, String) CODEC(ZSTD(1)), `_hash_map_string_39` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_string_39)), `attributes_float_0` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_0` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_0)), `attributes_float_1` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_1` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_1)), `attributes_float_2` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_2` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_2)), `attributes_float_3` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_3` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_3)), `attributes_float_4` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_4` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_4)), `attributes_float_5` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_5` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_5)), `attributes_float_6` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_6` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_6)), `attributes_float_7` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_7` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_7)), `attributes_float_8` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_8` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_8)), `attributes_float_9` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_9` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_9)), `attributes_float_10` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_10` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_10)), `attributes_float_11` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_11` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_11)), `attributes_float_12` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_12` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_12)), `attributes_float_13` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_13` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_13)), `attributes_float_14` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_14` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_14)), `attributes_float_15` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_15` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_15)), `attributes_float_16` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_16` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_16)), `attributes_float_17` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_17` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_17)), `attributes_float_18` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_18` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_18)), `attributes_float_19` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_19` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_19)), `attributes_float_20` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_20` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_20)), `attributes_float_21` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_21` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_21)), `attributes_float_22` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_22` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_22)), `attributes_float_23` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_23` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_23)), `attributes_float_24` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_24` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_24)), `attributes_float_25` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_25` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_25)), `attributes_float_26` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_26` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_26)), `attributes_float_27` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_27` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_27)), `attributes_float_28` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_28` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_28)), `attributes_float_29` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_29` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_29)), `attributes_float_30` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_30` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_30)), `attributes_float_31` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_31` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_31)), `attributes_float_32` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_32` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_32)), `attributes_float_33` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_33` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_33)), `attributes_float_34` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_34` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_34)), `attributes_float_35` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_35` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_35)), `attributes_float_36` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_36` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_36)), `attributes_float_37` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_37` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_37)), `attributes_float_38` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_38` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_38)), `attributes_float_39` Map(String, Float64) CODEC(ZSTD(1)), `_hash_map_float_39` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attributes_float_39))) ENGINE = Distributed('snuba-events-analytics-platform', 'default', 'eap_items_1_local', cityHash64(reinterpretAsUInt128(trace_id)))",
    "CREATE TABLE IF NOT EXISTS new_eap_spans_2_dist (`organization_id` UInt64, `project_id` UInt64, `service` String CODEC(ZSTD(1)), `trace_id` UUID, `span_id` UInt64, `parent_span_id` UInt64 CODEC(ZSTD(1)), `segment_id` UInt64 CODEC(ZSTD(1)), `segment_name` String CODEC(ZSTD(1)), `is_segment` UInt8 CODEC(LZ4), `_sort_timestamp` DateTime CODEC(DoubleDelta, ZSTD(1)), `start_timestamp` DateTime64(6) CODEC(DoubleDelta, ZSTD(1)), `end_timestamp` DateTime64(6) CODEC(DoubleDelta, ZSTD(1)), `duration_micro` UInt64 CODEC(T64, ZSTD(1)), `exclusive_time_micro` UInt64 CODEC(T64, ZSTD(1)), `retention_days` UInt16 CODEC(T64, ZSTD(1)), `name` String CODEC(ZSTD(1)), `sampling_factor` Float64 CODEC(ZSTD(1)), `sampling_weight` UInt64 CODEC(ZSTD(1)), `sign` Int8 CODEC(LZ4), `attr_str_0` Map(String, String) CODEC(ZSTD(1)), `attr_str_1` Map(String, String) CODEC(ZSTD(1)), `attr_str_2` Map(String, String) CODEC(ZSTD(1)), `attr_str_3` Map(String, String) CODEC(ZSTD(1)), `attr_str_4` Map(String, String) CODEC(ZSTD(1)), `attr_str_5` Map(String, String) CODEC(ZSTD(1)), `attr_str_6` Map(String, String) CODEC(ZSTD(1)), `attr_str_7` Map(String, String) CODEC(ZSTD(1)), `attr_str_8` Map(String, String) CODEC(ZSTD(1)), `attr_str_9` Map(String, String) CODEC(ZSTD(1)), `attr_str_10` Map(String, String) CODEC(ZSTD(1)), `attr_str_11` Map(String, String) CODEC(ZSTD(1)), `attr_str_12` Map(String, String) CODEC(ZSTD(1)), `attr_str_13` Map(String, String) CODEC(ZSTD(1)), `attr_str_14` Map(String, String) CODEC(ZSTD(1)), `attr_str_15` Map(String, String) CODEC(ZSTD(1)), `attr_str_16` Map(String, String) CODEC(ZSTD(1)), `attr_str_17` Map(String, String) CODEC(ZSTD(1)), `attr_str_18` Map(String, String) CODEC(ZSTD(1)), `attr_str_19` Map(String, String) CODEC(ZSTD(1)), `attr_num_0` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_1` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_2` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_3` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_4` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_5` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_6` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_7` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_8` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_9` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_10` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_11` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_12` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_13` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_14` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_15` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_16` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_17` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_18` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_19` Map(String, Float64) CODEC(ZSTD(1))) ENGINE = Distributed('snuba-events-analytics-platform', 'default', 'eap_spans_2_local', cityHash64(reinterpretAsUInt128(trace_id)))",
    "CREATE TABLE IF NOT EXISTS new_eap_spans_dist (`organization_id` UInt64, `project_id` UInt64, `service` String CODEC(ZSTD(1)), `trace_id` UUID, `span_id` UInt64, `parent_span_id` UInt64 CODEC(ZSTD(1)), `segment_id` UInt64 CODEC(ZSTD(1)), `segment_name` String CODEC(ZSTD(1)), `is_segment` UInt8 CODEC(T64, ZSTD(1)), `_sort_timestamp` DateTime CODEC(DoubleDelta, ZSTD(1)), `start_timestamp` DateTime64(6) CODEC(DoubleDelta, ZSTD(1)), `end_timestamp` DateTime64(6) CODEC(DoubleDelta, ZSTD(1)), `duration_ms` UInt32 CODEC(DoubleDelta, ZSTD(1)), `exclusive_time_ms` Float64 CODEC(ZSTD(1)), `retention_days` UInt16 CODEC(DoubleDelta, ZSTD(1)), `name` String CODEC(ZSTD(1)), `sampling_factor` Float64 CODEC(ZSTD(1)), `sampling_weight` Float64 CODEC(ZSTD(1)), `sampling_weight_2` UInt64 CODEC(ZSTD(1)), `sign` Int8 CODEC(DoubleDelta), `attr_str_0` Map(String, String) CODEC(ZSTD(1)), `attr_str_1` Map(String, String) CODEC(ZSTD(1)), `attr_str_2` Map(String, String) CODEC(ZSTD(1)), `attr_str_3` Map(String, String) CODEC(ZSTD(1)), `attr_str_4` Map(String, String) CODEC(ZSTD(1)), `attr_str_5` Map(String, String) CODEC(ZSTD(1)), `attr_str_6` Map(String, String) CODEC(ZSTD(1)), `attr_str_7` Map(String, String) CODEC(ZSTD(1)), `attr_str_8` Map(String, String) CODEC(ZSTD(1)), `attr_str_9` Map(String, String) CODEC(ZSTD(1)), `attr_str_10` Map(String, String) CODEC(ZSTD(1)), `attr_str_11` Map(String, String) CODEC(ZSTD(1)), `attr_str_12` Map(String, String) CODEC(ZSTD(1)), `attr_str_13` Map(String, String) CODEC(ZSTD(1)), `attr_str_14` Map(String, String) CODEC(ZSTD(1)), `attr_str_15` Map(String, String) CODEC(ZSTD(1)), `attr_str_16` Map(String, String) CODEC(ZSTD(1)), `attr_str_17` Map(String, String) CODEC(ZSTD(1)), `attr_str_18` Map(String, String) CODEC(ZSTD(1)), `attr_str_19` Map(String, String) CODEC(ZSTD(1)), `attr_num_0` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_1` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_2` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_3` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_4` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_5` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_6` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_7` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_8` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_9` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_10` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_11` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_12` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_13` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_14` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_15` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_16` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_17` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_18` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_19` Map(String, Float64) CODEC(ZSTD(1))) ENGINE = Distributed('snuba-events-analytics-platform', 'default', 'eap_spans_local', cityHash64(reinterpretAsUInt128(trace_id)))",
    "CREATE TABLE IF NOT EXISTS new_eap_trace_item_attrs_dist (`project_id` UInt64, `item_type` String, `date` Date CODEC(DoubleDelta, ZSTD(1)), `retention_days` UInt16, `attrs_string` Map(String, String), `_str_attr_keys_hashes` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), mapKeys(attrs_string)), `attrs_bool` Array(String), `attrs_int64` Array(String), `attrs_float64` Array(String), `_float64_attr_keys_hashes` Array(UInt64) MATERIALIZED arrayMap(k -> cityHash64(k), attrs_float64), `key_val_hash` UInt64) ENGINE = Distributed('snuba-events-analytics-platform', 'default', 'eap_trace_item_attrs_local')",
    "CREATE TABLE IF NOT EXISTS new_ourlogs_2_dist (`organization_id` UInt64, `project_id` UInt64, `trace_id` UUID, `span_id` UInt64, `severity_text` String, `severity_number` UInt8, `retention_days` UInt16, `timestamp` DateTime64(9), `body` String CODEC(ZSTD(1)), `attr_string` Map(String, String), `attr_int` Map(String, Int64), `attr_double` Map(String, Float64), `attr_bool` Map(String, UInt8)) ENGINE = Distributed('snuba-events-analytics-platform', 'default', 'ourlogs_2_local', rand())",
    "CREATE TABLE IF NOT EXISTS new_ourlogs_dist (`organization_id` UInt64, `project_id` UInt64, `trace_id` UUID, `span_id` UInt64, `severity_text` String, `severity_number` UInt8, `retention_days` UInt16, `timestamp` DateTime64(9), `body` String CODEC(ZSTD(1)), `attr_str_0` Map(String, String) CODEC(ZSTD(1)), `attr_str_1` Map(String, String) CODEC(ZSTD(1)), `attr_str_2` Map(String, String) CODEC(ZSTD(1)), `attr_str_3` Map(String, String) CODEC(ZSTD(1)), `attr_str_4` Map(String, String) CODEC(ZSTD(1)), `attr_str_5` Map(String, String) CODEC(ZSTD(1)), `attr_str_6` Map(String, String) CODEC(ZSTD(1)), `attr_str_7` Map(String, String) CODEC(ZSTD(1)), `attr_str_8` Map(String, String) CODEC(ZSTD(1)), `attr_str_9` Map(String, String) CODEC(ZSTD(1)), `attr_str_10` Map(String, String) CODEC(ZSTD(1)), `attr_str_11` Map(String, String) CODEC(ZSTD(1)), `attr_str_12` Map(String, String) CODEC(ZSTD(1)), `attr_str_13` Map(String, String) CODEC(ZSTD(1)), `attr_str_14` Map(String, String) CODEC(ZSTD(1)), `attr_str_15` Map(String, String) CODEC(ZSTD(1)), `attr_str_16` Map(String, String) CODEC(ZSTD(1)), `attr_str_17` Map(String, String) CODEC(ZSTD(1)), `attr_str_18` Map(String, String) CODEC(ZSTD(1)), `attr_str_19` Map(String, String) CODEC(ZSTD(1)), `attr_num_0` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_1` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_2` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_3` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_4` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_5` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_6` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_7` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_8` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_9` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_10` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_11` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_12` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_13` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_14` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_15` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_16` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_17` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_18` Map(String, Float64) CODEC(ZSTD(1)), `attr_num_19` Map(String, Float64) CODEC(ZSTD(1))) ENGINE = Distributed('snuba-events-analytics-platform', 'default', 'ourlogs_local', rand())",
    "CREATE TABLE IF NOT EXISTS new_spans_attributes_meta_dist (`organization_id` UInt64, `attribute_type` String, `attribute_key` String, `attribute_value` String, `timestamp` DateTime CODEC(DoubleDelta), `retention_days` UInt16, `count` AggregateFunction(sum, UInt64)) ENGINE = Distributed('snuba-events-analytics-platform', 'default', 'spans_attributes_meta_local')",
    "CREATE TABLE IF NOT EXISTS new_spans_num_attrs_2_dist (`organization_id` UInt64, `project_id` UInt64, `attr_key` String, `attr_min_value` SimpleAggregateFunction(min, Float64), `attr_max_value` SimpleAggregateFunction(max, Float64), `timestamp` DateTime CODEC(ZSTD(1)), `retention_days` UInt16, `count` SimpleAggregateFunction(sum, UInt64)) ENGINE = Distributed('snuba-events-analytics-platform', 'default', 'spans_num_attrs_2_local')",
    "CREATE TABLE IF NOT EXISTS new_spans_num_attrs_3_dist (`organization_id` UInt64, `project_id` UInt64, `attr_key` String CODEC(ZSTD(1)), `attr_min_value` SimpleAggregateFunction(min, Float64), `attr_max_value` SimpleAggregateFunction(max, Float64), `timestamp` DateTime CODEC(DoubleDelta, ZSTD(1)), `retention_days` UInt16, `count` SimpleAggregateFunction(sum, UInt64)) ENGINE = Distributed('snuba-events-analytics-platform', 'default', 'spans_num_attrs_3_local')",
    "CREATE TABLE IF NOT EXISTS new_spans_str_attrs_2_dist (`organization_id` UInt64, `project_id` UInt64, `attr_key` String CODEC(ZSTD(1)), `attr_value` String CODEC(ZSTD(1)), `timestamp` DateTime CODEC(ZSTD(1)), `retention_days` UInt16, `count` SimpleAggregateFunction(sum, UInt64)) ENGINE = Distributed('snuba-events-analytics-platform', 'default', 'spans_str_attrs_2_local')",
    "CREATE TABLE IF NOT EXISTS new_spans_str_attrs_3_dist (`organization_id` UInt64, `project_id` UInt64, `attr_key` String CODEC(ZSTD(1)), `attr_value` String CODEC(ZSTD(1)), `timestamp` DateTime CODEC(DoubleDelta, ZSTD(1)), `retention_days` UInt16, `count` SimpleAggregateFunction(sum, UInt64)) ENGINE = Distributed('snuba-events-analytics-platform', 'default', 'spans_str_attrs_3_local')",
    "CREATE TABLE IF NOT EXISTS new_uptime_monitor_checks_dist (`organization_id` UInt64, `project_id` UInt64, `environment` LowCardinality(Nullable(String)), `uptime_subscription_id` UUID, `uptime_check_id` UUID, `scheduled_check_time` DateTime64(3), `timestamp` DateTime64(3), `duration_ms` UInt64, `region_slug` LowCardinality(String), `check_status` LowCardinality(String), `check_status_reason` LowCardinality(String), `http_status_code` Nullable(UInt16), `trace_id` UUID, `retention_days` UInt16) ENGINE = Distributed('snuba-events-analytics-platform', 'default', 'uptime_monitor_checks_local', cityHash64(reinterpretAsUInt128(trace_id)))",
    "CREATE TABLE IF NOT EXISTS new_uptime_monitor_checks_v2_dist (`organization_id` UInt64, `project_id` UInt64, `environment` LowCardinality(Nullable(String)), `uptime_subscription_id` UUID, `uptime_check_id` UUID, `scheduled_check_time` DateTime, `timestamp` DateTime64(3), `duration_ms` UInt64, `region` LowCardinality(String), `check_status` LowCardinality(String), `check_status_reason` LowCardinality(String), `http_status_code` Nullable(UInt16), `trace_id` UUID, `retention_days` UInt16, `incident_status` UInt16) ENGINE = Distributed('snuba-events-analytics-platform', 'default', 'uptime_monitor_checks_v2_local', cityHash64(reinterpretAsUInt128(trace_id)))",
}

tables = {
    "eap_items_1_dist",
    "eap_spans_2_dist",
    "eap_spans_dist",
    "eap_trace_item_attrs_dist",
    "ourlogs_2_dist",
    "ourlogs_dist",
    "spans_attributes_meta_dist",
    "spans_num_attrs_2_dist",
    "spans_num_attrs_3_dist",
    "spans_str_attrs_2_dist",
    "spans_str_attrs_3_dist",
    "uptime_monitor_checks_dist",
    "uptime_monitor_checks_v2_dist",
}


class RecreateEAPDistTables(Job):
    def __init__(self, job_spec: JobSpec) -> None:
        super().__init__(job_spec)

    def execute(self, logger: JobLogger) -> None:
        cluster = get_cluster(StorageSetKey.EVENTS_ANALYTICS_PLATFORM)

        for storage_node in cluster.get_distributed_nodes():
            connection = cluster.get_node_connection(
                ClickhouseClientSettings.MIGRATE,
                storage_node,
            )
            for statement in statements:
                logger.info("Run create table statement: {statement}")
                connection.execute(query=statement)

            for table_name in tables:
                statement = f"RENAME TABLE {table_name} TO old_{table_name}, new_{table_name} TO {table_name}"
                logger.info("Rename table: {statement}")
                connection.execute(query=statement)

        logger.info("complete")
