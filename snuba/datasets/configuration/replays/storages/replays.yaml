version: v1
kind: writable_storage
name: replays
storage:
  key: replays
  set_key: replays
readiness_state: complete
schema:
  columns:
    [
      { name: browser_name, type: String },
      { name: browser_version, type: String },
      { name: click_alt, type: String },
      { name: click_aria_label, type: String },
      {
        name: click_class,
        type: Array,
        args: { inner_type: { type: String } },
      },
      { name: click_id, type: String },
      { name: click_is_dead, type: UInt, args: { size: 8 } },
      { name: click_is_rage, type: UInt, args: { size: 8 } },
      { name: click_node_id, type: UInt, args: { size: 32 } },
      {
        name: click_role,
        type: String,
        args: { schema_modifiers: [low_cardiality] },
      },
      {
        name: click_tag,
        type: String,
        args: { schema_modifiers: [low_cardiality] },
      },
      { name: click_testid, type: String },
      { name: click_text, type: String },
      { name: click_title, type: String },
      { name: device_brand, type: String },
      { name: device_family, type: String },
      { name: device_model, type: String },
      { name: device_name, type: String },
      { name: dist, type: String },
      { name: environment, type: String },
      { name: error_ids, type: Array, args: { inner_type: { type: UUID } } },
      { name: error_sample_rate, type: Float, args: { size: 64 } },
      { name: event_hash, type: UUID },
      { name: ip_address_v4, type: IPv4 },
      { name: ip_address_v6, type: IPv6 },
      { name: is_archived, type: UInt, args: { size: 8 } },
      { name: offset, type: UInt, args: { size: 64 } },
      { name: os_name, type: String },
      { name: os_version, type: String },
      { name: partition, type: UInt, args: { size: 16 } },
      { name: platform, type: String },
      { name: project_id, type: UInt, args: { size: 64 } },
      { name: release, type: String },
      { name: replay_id, type: UUID },
      {
        name: replay_start_timestamp,
        type: DateTime,
        args: { schema_modifiers: [nullable] },
      },
      {
        name: replay_type,
        type: String,
        args: { schema_modifiers: [low_cardinality] },
      },
      { name: retention_days, type: UInt, args: { size: 16 } },
      { name: sdk_name, type: String },
      { name: sdk_version, type: String },
      {
        name: segment_id,
        type: UInt,
        args: { schema_modifiers: [nullable], size: 16 },
      },
      { name: session_sample_rate, type: Float, args: { size: 64 } },
      {
        name: tags,
        type: Nested,
        args:
          {
            subcolumns:
              [{ name: key, type: String }, { name: value, type: String }],
          },
      },
      { name: timestamp, type: DateTime },
      { name: title, type: String, args: { schema_modifiers: [readonly] } },
      { name: trace_ids, type: Array, args: { inner_type: { type: UUID } } },
      { name: url, type: String, args: { schema_modifiers: [nullable] } },
      { name: urls, type: Array, args: { inner_type: { type: String } } },
      { name: user_email, type: String },
      { name: user_id, type: String },
      { name: user_name, type: String },
      { name: user, type: String },
    ]
  local_table_name: replays_local
  dist_table_name: replays_dist
query_processors:
  - processor: TableRateLimit
  - processor: ClickhouseSettingsOverride
    args:
      settings:
        max_rows_to_group_by: 1000000
        group_by_overflow_mode: any
mandatory_condition_checkers:
  - condition: ProjectIdEnforcer
stream_loader:
  processor:
    name: ReplaysProcessor
  default_topic: ingest-replay-events
  dlq_topic: snuba-dead-letter-replays
allocation_policies:
  - name: BytesScannedWindowAllocationPolicy
    args:
      required_tenant_types:
        - organization_id
        - referrer
      default_config_overrides:
        is_enforced: 1
        throttled_thread_number: 1
        org_limit_bytes_scanned: 100000
