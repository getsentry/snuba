name: ci
on:
  push:
    # To make sure it runs on my fork
    # branches:
    #   - master
    #   - releases/**
  pull_request:

jobs:
  tests:
    name: frontend tests
    runs-on: ubuntu-18.04
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v2
        name: Checkout code
      - name: Docker set up
        run: |
          docker pull getsentry/snuba:latest || true
          docker build --build-arg PYTHON_VERSION=3.8 -t getsentry/snuba . --cache-from getsentry/snuba:latest
          docker network create --attachable cloudbuild
      - name: Docker Snuba tests
        run: |
          SNUBA_IMAGE=getsentry/snuba docker-compose -f docker-compose.gcb.yml run --rm snuba-test
      - name: Submit articfacts to Zeus
        run: |
          npm install -g @zeus-ci/cli
          $(npm bin -g)/zeus upload -t "application/x-junit+xml" .artifacts/*.junit.xml
          $(npm bin -g)/zeus upload -t "application/x-cobertura+xml" .artifacts/coverage.xml
