name: ci
on:
  push:
    branches:
      - master
  pull_request:

jobs:
  buildkit-pull:
    name: Build kit with pulling
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # We are only using ghcr here for CI as `setup-gcloud` is a bit slow
      # Should revisit this when we move off of google cloud build (we may want to move these to GCR)
      - name: Registry login
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

      - name: Pull snuba CI images
        run: |
          docker pull ghcr.io/getsentry/snuba-ci:bk-pull-${{ github.sha }} || true

      - name: Build snuba docker image for CI
        env:
          DOCKER_BUILDKIT: 1
        run: |
          docker build . \
            --build-arg PYTHON_VERSION=3.8 \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -t ghcr.io/getsentry/snuba-ci:bk-pull-${{ github.sha }} \
            --cache-from ghcr.io/getsentry/snuba-ci:bk-pull-${{ github.sha }} \
            --target testing

      - name: Publish images for cache
        run: |
          docker push ghcr.io/getsentry/snuba-ci:bk-pull-${{ github.sha }}

  buildkit-no-pull:
    name: Build kit without pulling
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # We are only using ghcr here for CI as `setup-gcloud` is a bit slow
      # Should revisit this when we move off of google cloud build (we may want to move these to GCR)
      - name: Registry login
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

      - name: Build snuba docker image for CI
        env:
          DOCKER_BUILDKIT: 1
        run: |
          docker build . \
            --build-arg PYTHON_VERSION=3.8 \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -t ghcr.io/getsentry/snuba-ci:bk-np-${{ github.sha }} \
            --cache-from ghcr.io/getsentry/snuba-ci:bk-np-${{ github.sha }} \
            --target testing

      - name: Publish images for cache
        run: |
          docker push ghcr.io/getsentry/snuba-ci:bk-np-${{ github.sha }}

  no-cache-from:
    name: Non-buildkit without cache-from
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      # We are only using ghcr here for CI as `setup-gcloud` is a bit slow
      # Should revisit this when we move off of google cloud build (we may want to move these to GCR)
      - name: Registry login
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

      - name: Pull snuba CI images
        run: |
          docker pull ghcr.io/getsentry/snuba-ci:no-cache-from-${{ github.sha }} || true

      - name: Build snuba docker image for CI
        run: |
          docker build . \
            --build-arg PYTHON_VERSION=3.8 \
            -t ghcr.io/getsentry/snuba-ci:no-cache-from-${{ github.sha }} \
            --target testing

      - name: Publish images for cache
        run: |
          docker push ghcr.io/getsentry/snuba-ci:no-cache-from-${{ github.sha }}
