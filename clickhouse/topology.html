
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>ClickHouse Topology Best Practices &#8212; Snuba 25.11.0.dev0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ClickHouse Schema Design Best Practices" href="schema_design.html" />
    <link rel="prev" title="Snuba development environment" href="../contributing/environment.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="clickhouse-topology-best-practices">
<h1>ClickHouse Topology Best Practices<a class="headerlink" href="#clickhouse-topology-best-practices" title="Permalink to this heading">¶</a></h1>
<p>Sentry has a few conventions for using ClickHouse that are not inherent to
the database but useful to consider if you intend to create new tables or
datasets.</p>
<section id="storage-nodes-vs-query-nodes">
<h2>Storage nodes vs. Query nodes<a class="headerlink" href="#storage-nodes-vs-query-nodes" title="Permalink to this heading">¶</a></h2>
<p>We tend to deploy two different types of nodes in production:</p>
<ol class="arabic simple">
<li><p>storage nodes – these contain table data for a given shard, and replicate
data between other nodes of that shard. For most datasets, they
are not queried directly.</p></li>
<li><p>query nodes – these contain references to tables on storage nodes via
distributed tables, and are intended to be queried directly by the API or
written to directly by consumers. They do not themselves store data but aggregate
or delegate to tables on the storage node.</p></li>
</ol>
<p>This separation allows us to do maintenance on storage nodes in a way that is
invisible to the application (as the query nodes generally act as a proxy, and
can more generally be kept up indefinitely).</p>
</section>
<section id="distributed-tables-vs-local-tables">
<h2>Distributed Tables vs. Local Tables<a class="headerlink" href="#distributed-tables-vs-local-tables" title="Permalink to this heading">¶</a></h2>
<p>Astute snuba users might notice that migrations contain references to tables with names
suffixed with <code class="docutils literal notranslate"><span class="pre">_local</span></code> and table names suffixed with <code class="docutils literal notranslate"><span class="pre">_dist</span></code>. This is used to
distinguish between distributed tables (generally using the ClickHouse table engine
<a class="reference external" href="https://clickhouse.com/docs/en/engines/table-engines/special/distributed/">Distributed</a>)
and local tables (generally using one of the
<a class="reference external" href="https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/">MergeTree-derived</a>
table engines). Distributed tables exist to aggregate from the shards of local tables, and following
the sequence above, distributed tables tend to be created on query nodes and local tables
tend to be created on storage nodes.</p>
</section>
<section id="tying-it-all-together">
<h2>Tying it all together<a class="headerlink" href="#tying-it-all-together" title="Permalink to this heading">¶</a></h2>
<p>This diagram hopefully combines all the above concepts into an understandable
quick to consume format.</p>
<img alt="../_images/clickhouse_nodes.png" src="../_images/clickhouse_nodes.png" />
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/snuba.svg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">Snuba</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getstarted.html">Getting started with Snuba</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/overview.html">Snuba Architecture Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/overview.html#snuba-within-a-sentry-deployment">Snuba within a Sentry Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/datamodel.html">Snuba Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/slicing.html">Snuba Data Slicing (under development)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/slicing.html#configuring-a-slice">Configuring a slice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/slicing.html#working-in-a-sliced-environment">Working in a Sliced Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/queryprocessing.html">Snuba Query Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/consumer.html">Snuba Consumers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/overview.html">Dataset Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../query/overview.html">Querying Snuba</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language/snql.html">The SnQL query language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language/mql.html">The MQL query language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migrations/modes.html">Snuba Migration Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/environment.html">Snuba development environment</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">ClickHouse Topology Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema_design.html">ClickHouse Schema Design Best Practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="supported_versions.html">ClickHouse supported versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiler.html">Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiler.html#regular-transaction-profiling">Regular transaction profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../profiler.html#on-demand-profiling">On-demand profiling</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../contributing/environment.html" title="previous chapter">Snuba development environment</a></li>
      <li>Next: <a href="schema_design.html" title="next chapter">ClickHouse Schema Design Best Practices</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Sentry Team and Contributors.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/clickhouse/topology.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>