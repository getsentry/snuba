sudo: required
services:
  - docker
  - redis-server
dist: trusty
language: python
env:
  global:
    - CACHE_DIR=$HOME/.cache/docker
    - CACHE_FILE_SNUBA=$CACHE_DIR/snuba.tar.gz
    - IMAGE_NAME=getsentry/snuba
    # DOCKER_USER
    - secure: "ysSap4g0Sv1RsE0taeTeloJNpsaeJzcbZoBVX6+jfTvI1AP38LZLD6uptfj+6SEF/winfcSwzSdtIMrM44V0I5d3qXfVVYJsPCXi/P2V9nKSjhRUWNcYIMEAhwzwHIldTck4AM84am4xh6Mq9z+Wt4WVAJvyZ/6SDWNmcm0Jo7EvHOgSbtxRmRLLZ5mR7ttk9EswnJwy5VKBHMcp9PNZwVxdAiSXSTEKckE+zpgnqPN0WlgtFP2CdHRlO8CHmjxOSrwxabdsF7ehk1asTiA3Z5LQLp5FkMVZDeuR5uN3UKnvO99/I3BYkl6F9WD/6Agj9RhUdCjYbb9WgDFuCic+Q03jyVxTY1ZK1g6D35Vjpxsythv6Aloj4Y2JCRxx3cjRACDXUqSuFN09S1JFzn0izv5BOpPC//BLW+mV9vzaY9/CAyMsr17mKM7PE5SV71BgyDgBIijN0Pc22q31kNSpcAAnkqXdvDVbd3xiOCUW5Ih9uyLoDS1feppbXOdcED5gEdhXqT++fA77m+FEX7f53BsuoqPfHzanxtJjGNLWAuQI1cgJlJko0OOE5V9/nzhv3tYhIvWrQuob9J4YMvrfCg+YG1TA9xcQAIdXt8WJBZgdBt5dMMKWlEjCXxE+MJklCsMp+uYD7hrAVoJqnMgtnfBhcmf43qUyJ8WGIZU83Ok="
    # DOCKER_PASS
    - secure: "JyjazLIoW2loRpWbTVtcXa14bwPtJd0v0Xy9tPN5ZwT6flVAB9oAJZOp3YslSlgOPGHV6p9AfQYS0avq+D7gwWA5l6T39AGEZWv3C8nig8Jk+HGhskZGlDTv0QE9p/DZOHqHjwuyC1nuQ/khTpvPuUkO7dhbluwC3iYbBKs9TRHytPkuSCUpmXAaFXHQHPcOZCy82TKBhreAS1tdBKCsW9/ooEtk0o6MsDT9b+Ec7fFfRl1vIVBybcd1bku/VW9p+DJCrRAudNDSQq055ow/AxC3ZW1YTk8a4izsO/Ywmuq7rdQHXqsZ5ogksZKQN7UsrPfqioPQ94t/lSh+6ync5qBRLhWNUKt6tF1GABol5BlohDVizcMfF3jAmJ1+s4xdrqPANpDHLllbfVqZmALzItPmJdLQ2W6xo1CHd2q/zCvPK1DIYHx7gDYYKwhDoiafACPLw+dKeNJvbqKwqtU+nVMSd7Fv+QPADyiq7/pbd82O/GXuVz6BZeecLVKbAgqb+rNPBsNt5LznJu4gctXU341xLU3W48a2hB1m16Trke5+tW+bDMNekC5gZXFqdi2oR0FoHtM73OKoacnb1QxGAO0K3li78EPcmnZkqMDMc/Z020JMtpaySxPbIMV20p9pieso6QlyFc1osZCcEe/+YmUEkOd7bZ7s6CjB4QI3gRQ="
cache:
  pip: true
  directories:
  - $CACHE_DIR
before_install:
  - mkdir -p $CACHE_DIR
  - docker run -d --name clickhouse-server -p 9000:9000 -p 9009:9009 -p 8123:8123 --ulimit nofile=262144:262144 yandex/clickhouse-server
  - make install-librdkafka
  - make install-python-dependencies
  - if [ -f ${CACHE_FILE_SNUBA} ]; then gzip -dc $CACHE_FILE_SNUBA | docker load; fi
script:
  - make test
before_deploy:
  - docker pull "$IMAGE_NAME" || true
  - docker build --pull --cache-from "$IMAGE_NAME" --tag "$IMAGE_NAME" .
  - docker save $IMAGE_NAME | gzip > $CACHE_FILE_SNUBA
  - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
  - docker tag "$IMAGE_NAME" "${IMAGE_NAME}:latest"
  - docker tag "$IMAGE_NAME" "${IMAGE_NAME}:$(git rev-parse HEAD)"
deploy:
  skip_cleanup: true
  provider: script
  script: docker push "${IMAGE_NAME}:latest" && docker push "${IMAGE_NAME}:$(git rev-parse HEAD)"
  on:
    branch: master
